let user,token,Rappr,classi,sondaggi,numScelta,voto,t,btnAzione,contOpzioni,sond,preview,face2,oggetto,domanda,invia,autorizzato=!1,emailAutorizzate=[],opzioni=[],inviato=!1;function preload(){btnAzione=selectAll(".btnAzione"),sond=select(".sond"),preview=select(".preview"),face2=select(".fade2")}function setup(){noCanvas(),firebaseInit();let a=firebase.database();a.ref("Sondaggi").once("value",b=>{if(sondaggi=b.val(),sondaggi.Attivo){for(let a=0;a<sondaggi.Opzioni.length;a++)sondaggi.VotiPush&&sondaggi.VotiPush[a]?console.log(sondaggi.Opzioni[a]+" : "+Object.keys(sondaggi.VotiPush[a]).length):console.log(sondaggi.Opzioni[a]+" : 0");t=["mQRrmzRqQpGQ7TqLFvEZ","DPlyDNMd5NA8OAiy36hB"],0===sondaggi.LivAutorizzazione?(Rappr="Anonimo",checkInserimento(Rappr,"ip")?preview.html("Hai gi\xE0 votato!"):(preview.html("\u272C Sondaggio "+sondaggi.Data+"</br>Accesso: Tutti (anonimi senza login)"),autorizzato=!0,face2.addClass("open"))):1===sondaggi.LivAutorizzazione&&preview.html("\u272C Sondaggio "+sondaggi.Data+"</br>Accesso: Rappresentanti di classe"),oggetto=createElement("h2",sondaggi.Oggetto).parent(sond),domanda=createElement("p",sondaggi.Domanda).parent(sond),contOpzioni=createElement("div").addClass("contOpzioni").parent(sond),t[0]=t[0].split("").reverse().join(""),t[1]=t[1].split("").reverse().join("");for(let a=0;a<sondaggi.Opzioni.length;a++)opzioni.push(createElement("a",sondaggi.Opzioni[a]).parent(contOpzioni)),opzioni[a].attribute("href","javascript:void(0)"),opzioni[a].addClass("unSel"),opzioni[a].mouseClicked(()=>{for(let a=0;a<opzioni.length;a++)opzioni[a].addClass("unSel"),opzioni[a].removeClass("selOpz");opzioni[a].removeClass("unSel"),opzioni[a].addClass("selOpz"),numScelta=a});invia=createElement("a","INVIA").parent(sond),invia.attribute("href","javascript:void(0)"),invia.addClass("invia"),invia.mouseClicked(()=>{!0===autorizzato&&a.ref("Sondaggi").once("value").then(b=>{inviato||checkIP(b)||(a.ref(`Sondaggi/VotiPush/${numScelta}`).push({r:Rappr,k:t[1],ip:IP_ADDRESS}),a.ref(`Sondaggi/Voti/${numScelta}`).push({ip:IP_ADDRESS,r:Rappr}),a.ref("Sondaggi/IP_ADDRESSES").push({ip:IP_ADDRESS,k:t[0]}),location.reload())})}),firebase.auth().getRedirectResult().then(a=>{a.credential&&(token=a.credential.accessToken,user=a.user,btnAzione[1].html(user.displayName),btnAzione[1].addClass("logEff"),btnAzione[1].attribute("title","LOGOUT"),0===sondaggi.LivAutorizzazione&&user.displayName&&(Rappr=user.displayName),1===sondaggi.LivAutorizzazione&&(checkUserAutorizzato1(user),!0===autorizzato&&(checkInserimento(Rappr)?preview.html("\u272C Sondaggio "+sondaggi.Data+"</br> "+voto):face2.addClass("open"))))})}else preview.html("\u2298 Nessun sondaggio attivo")},()=>{console.log("errSondaggi")});let b=new firebase.auth.GoogleAuthProvider;b.addScope("profile"),b.addScope("email"),btnAzione[1].mouseClicked(()=>{user===void 0?firebase.auth().signInWithRedirect(b):location.reload()})}function firebaseInit(){firebase.initializeApp({apiKey:"AIzaSyCXHp1gsr4WnPRT1NqM-3W0WhDu9vZLwK8",authDomain:"sondaggiconsiglioistituto.firebaseapp.com",databaseURL:"https://sondaggiconsiglioistituto.firebaseio.com",projectId:"sondaggiconsiglioistituto",storageBucket:"sondaggiconsiglioistituto.appspot.com",messagingSenderId:"1070621130329",appId:"1:1070621130329:web:c9d380bd31c85038d53b48",measurementId:"G-FVCF0DS35E"}),firebase.analytics()}function checkUserAutorizzato1(a){for(let b=0;b<emailAutorizzate.length-4;b++)a.email===emailAutorizzate[b]&&(autorizzato=!0,Rappr=classi[b])}function checkUserAutorizzato2(a){for(let b=51;b<emailAutorizzate.length;b++)a.email===emailAutorizzate[b]&&(autorizzato=!0,Rappr="Membro del Consiglio: "+(b+1))}function checkInserimento(a,b="gmail"){if("gmail"===b){for(let b,c=0;c<Opzioni.length;c++){b=Object.values(sondaggi.VotiPush[c]);for(let d=0;d<b.length;d++)if(a===b[d])return voto="Il tuo voto: "+sondaggi.Opzioni[c],!0}if(sondaggi.IP_ADDRESSES){ipAddresses=Object.values(sondaggi.IP_ADDRESSES);for(let a=0;a<ipAddresses.length;a++)if(IP_ADDRESS===ipAddresses[a])return voto="Hai gi\xE0 votato!",!0}}else if("ip"===b&&sondaggi.IP_ADDRESSES){ipAddresses=Object.values(sondaggi.IP_ADDRESSES);for(let a=0;a<Object.keys(sondaggi.IP_ADDRESSES).length;a++)if(IP_ADDRESS===ipAddresses[a].ip)return!0}}function checkIP(a){inviato=!0;const b=a.val();if(b.IP_ADDRESSES){const a=Object.values(b.IP_ADDRESSES);console.log(a);for(let c=0;c<Object.keys(b.IP_ADDRESSES).length;c++)if(IP_ADDRESS===a[c].ip)return!0}return!1}
